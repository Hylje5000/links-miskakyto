name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

env:
  VM_HOST: 4.210.156.244
  VM_USER: miska
  DEPLOY_PATH: /home/miska/linkshortener

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run frontend tests
      run: npm test -- --passWithNoTests --watchAll=false
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        cd backend
        python -m pytest

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to VM
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to application directory (create if needed)
          mkdir -p ${{ env.DEPLOY_PATH }}
          cd ${{ env.DEPLOY_PATH }}
          
          # Stop services if running
          echo "ğŸ›‘ Stopping services..."
          if [ -f manage-fullstack.sh ]; then
            chmod +x manage-fullstack.sh
            ./manage-fullstack.sh stop || true
          fi
          
          # Initialize git repository if needed
          if [ ! -d .git ]; then
            echo "ğŸ“¦ Initializing git repository..."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
          fi
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin main || git fetch origin main  # Try twice in case of network issues
          git reset --hard origin/main
          
          # Make scripts executable
          chmod +x manage-fullstack.sh
          
          # Set up environment (preserve existing .env)
          if [ ! -f .env ]; then
            echo "âš ï¸ No .env file found. Creating from template..."
            cp backend/.env.production .env
            echo "â— Please configure .env file with your Azure AD credentials"
            echo "â— Deployment will continue but authentication will not work until .env is configured"
          else
            echo "âœ… Found existing .env file, keeping current configuration"
          fi
          
          # Force rebuild containers to pick up code changes
          echo "ğŸ—ï¸ Stopping existing containers..."
          ./manage-fullstack.sh stop
          
          echo "ğŸ—‘ï¸ Removing old images to force rebuild..."
          docker-compose -f docker-compose.fullstack.yml down --rmi local || true
          
          echo "ğŸ”¨ Building containers from scratch (no cache)..."
          export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          export VCS_REF=${{ github.sha }}
          export CACHEBUST=${{ github.run_number }}
          docker-compose -f docker-compose.fullstack.yml build --no-cache
          
          echo "ğŸš€ Starting services with fresh containers..."
          ./manage-fullstack.sh start
          
          # Wait for services to start
          sleep 20
          
          # Health check with both HTTP and HTTPS attempts
          echo "ğŸ¥ Running health checks..."
          
          # First check if containers are running
          if ! ./manage-fullstack.sh status | grep -q "Up"; then
            echo "âŒ Containers are not running properly"
            ./manage-fullstack.sh logs
            exit 1
          fi
          
          # Try health check (attempt both HTTP and HTTPS)
          echo "ğŸ” Checking application health..."
          if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
            echo "âœ… Application health check passed (HTTP)"
          elif curl -f -s -k https://links.miskakyto.fi/health > /dev/null 2>&1; then
            echo "âœ… Application health check passed (HTTPS)"
          else
            echo "âš ï¸ Direct health check failed, but services are running"
            echo "ğŸ“Š Container status:"
            ./manage-fullstack.sh status
            echo "ğŸ“ Recent logs:"
            ./manage-fullstack.sh logs --tail=50
            # Don't fail deployment if health check fails but containers are running
            echo "âš ï¸ Continuing deployment despite health check failure"
          fi
          
          echo "âœ… Deployment completed successfully!"

  deploy-notification:
    runs-on: ubuntu-latest
    name: Deployment Notification
    needs: deploy
    if: always()
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… Deployment to ${{ env.VM_HOST }} was successful!"
        echo "ğŸŒ Application should be available at: https://links.miskakyto.fi"
        echo "ğŸ“‹ If this is a fresh deployment, ensure .env is configured with Azure AD credentials"
    
    - name: Deployment Failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Deployment to ${{ env.VM_HOST }} failed!"
        echo "Please check the logs and deploy manually if needed."
        exit 1
